<div class="reports-page">
  <h1>Time Reports</h1>

  <!-- Controls Card -->
  <mat-card class="controls-card">
    <mat-card-content>
      <div class="controls-row">
        <!-- Date Selection -->
        <mat-form-field appearance="outline">
          <mat-label>Select Date</mat-label>
          <input matInput type="date" [value]="selectedDate()" (change)="onDateChange($event)" />
        </mat-form-field>

        <!-- Period Toggle -->
        <mat-button-toggle-group
          [value]="selectedPeriod()"
          (change)="onPeriodChange($event.value)"
          class="period-toggle"
        >
          <mat-button-toggle value="daily">Daily</mat-button-toggle>
          <mat-button-toggle value="weekly">Weekly</mat-button-toggle>
          <mat-button-toggle value="monthly">Monthly</mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading report data...</p>
  </div>
  }

  <!-- Dashboard Grid -->
  @if (!loading()) {
  <div class="dashboard-grid">
    <!-- Hours Stacked Bar Chart -->
    <div class="chart-item bar-chart">
      <app-hours-chart #hoursChart></app-hours-chart>
    </div>

    <!-- Category Pie Chart -->
    <!-- Temporarily disabled during migration to ApexCharts -->
    <!--
    <div class="chart-item pie-chart">
      <app-category-pie-chart
        #pieChart
        [date]="selectedDateObj()"
        period="weekly"
        title="Weekly Category Distribution"
      >
      </app-category-pie-chart>
    </div>
    -->

    <!-- Summary Stats Card -->
    <div class="chart-item summary-stats">
      <mat-card class="stats-card">
        <mat-card-header>
          <mat-card-title>{{ getPeriodLabel() }} Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">{{ getTotalHours().toFixed(1) }}</div>
              <div class="stat-label">Total Hours</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ reportData().length }}</div>
              <div class="stat-label">Activities</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ getUniqueCategories() }}</div>
              <div class="stat-label">Categories</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ getAverageSession().toFixed(1) }}</div>
              <div class="stat-label">Avg Session (h)</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Report Table -->
    <div class="chart-item data-table">
      <mat-card class="report-card">
        <mat-card-header>
          <mat-card-title
            >{{ getPeriodLabel() }} Time Tracking Summary for {{ selectedDate() }}</mat-card-title
          >
        </mat-card-header>

        <mat-card-content>
          <!-- No data message -->
          @if (reportData().length === 0) {
          <div class="no-data">
            <p>No time tracking data found for this date.</p>
          </div>
          }

          <!-- Data table -->
          @if (reportData().length > 0) {
          <div class="table-container">
            <table mat-table [dataSource]="reportData()" class="report-table">
              <!-- Category Column -->
              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef>Category</th>
                <td mat-cell *matCellDef="let row">{{ row.category }}</td>
              </ng-container>

              <!-- Subcategory Column -->
              <ng-container matColumnDef="subcategory">
                <th mat-header-cell *matHeaderCellDef>Subcategory</th>
                <td mat-cell *matCellDef="let row">
                  @if (row.subcategory) {
                  <span>{{ row.subcategory }}</span>
                  } @else {
                  <span class="empty-value">-</span>
                  }
                </td>
              </ng-container>

              <!-- Tags Column -->
              <ng-container matColumnDef="tags">
                <th mat-header-cell *matHeaderCellDef>Tags</th>
                <td mat-cell *matCellDef="let row">
                  @if (row.tags) {
                  <span>{{ row.tags }}</span>
                  } @else {
                  <span class="empty-value">-</span>
                  }
                </td>
              </ng-container>

              <!-- Hours Column -->
              <ng-container matColumnDef="hours">
                <th mat-header-cell *matHeaderCellDef>Hours</th>
                <td mat-cell *matCellDef="let row" class="hours-cell">
                  {{ row.hours.toFixed(2) }}
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>

            <!-- Total Hours -->
            <div class="total-row">
              <strong>Total Hours: {{ getTotalHours().toFixed(2) }}</strong>
            </div>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>
  }
</div>
